<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Data Display</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div id="dataContainer">
        <canvas id="radonChart" width="400" height="200"></canvas>
    </div>

    <script>
        const ws_data = new WebSocket(`wss://wss-data.telkomiot.id/APP64c1df4aa8cda19538/DEV64c1df7353b3a40485`);

        // Inisialisasi data grafik
        const chartData = {
            labels: [],
            datasets: [{
                label: 'ValueRadonReal',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                data: [],
            }],
        };

        const radonChart = new Chart(document.getElementById('radonChart').getContext('2d'), {
            type: 'line', // Change 'bar' to 'line'
            data: chartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        ws_data.onopen = function () {
            console.log('WebSocket Client Connected');
        };

        ws_data.onmessage = function (d) {
            try {
                const dt = JSON.parse(d.data);
                console.log(dt); // Tampilkan seluruh objek di konsol untuk memeriksa struktur data

                const convertNestedToSimpleJson = function (obj) {
                    const dummyObj = {};
                    for (let key in obj) {
                        const value = obj[key];
                        const type = typeof value;

                        if (['string', 'boolean'].includes(type) || (type === 'number' && !isNaN(value))) {
                            dummyObj[key] = value;
                        } else if (type === 'object') {
                            Object.assign(dummyObj, convertNestedToSimpleJson(value));
                        };
                    };
                    return dummyObj;
                };

                console.log(convertNestedToSimpleJson(dt));

                let value45 = dt[45];
                let value46 = dt[46];
                let value47 = dt[47];

                console.log(value45); // Output: 1
                console.log(value46); // Output: 2
                console.log(value47); // Output: 7

                // Logika penggabungan berdasarkan kondisi
                let hasil;
                if (!isNaN(value45) && !isNaN(value46) && !isNaN(value47)) {
                    hasil = value45 + value46 + value47;
                } else if (!isNaN(value45) && !isNaN(value46)) {
                    hasil = value45 + value46;
                } else if (!isNaN(value45)) {
                    hasil = value45;
                } else {
                    hasil = "Tidak ada kondisi yang memenuhi";
                }

                // Tampilkan hasil di konsol
                console.log(hasil);

                // Tambahkan nilai ke dalam data grafik
                chartData.labels.push(new Date().toLocaleTimeString());
                chartData.datasets[0].data.push(hasil);

                // Perbarui grafik
                radonChart.update();

            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        };
    </script>

</body>

</html>